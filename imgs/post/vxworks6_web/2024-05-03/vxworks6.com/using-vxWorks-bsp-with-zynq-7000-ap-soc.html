<!DOCTYPE HTML>
<html>
	<head>
		<title>Using VxWorks BSP with Zynq-7000 AP SoC</title>
		<link rel="icon" type="image/x-icon" href="images/favicon.ico">
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<!-- Code Highlight -->
		<link rel="stylesheet" type="text/css" href="codehl/prism.css"/>
		<script src="codehl/prism.js" type="text/javascript"> </script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

							<!-- Header -->
								<header id="header">
									<a href="index.html" class="logo"><strong>VxWorks</strong> RTOS</a>
									<ul class="icons">
										<li><a href="https://www.vxworks7.com" target="_blank" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
										<li><a href="https://www.vxworks.net" target="_blank" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
                                                                                <li><a href="https://www.gaitpu.com" target="_blank" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>

									</ul>
								</header>

							<!-- Content -->
								<section>
									<header class="main">
										<h1>Using VxWorks BSP with Zynq-7000 AP SoC</h1>
									</header>
                                                                </section>

									<!-- Content -->
										<div class="row">
											<div class="col-6 col-12-small">
												<span class="image"><img src="images/soc/VxWorks-on-Zynq-UltraScale-MPSoC.png" alt="VxWorks Zynq UltraScale" /></span>
											</div>
											<div class="col-6 col-12-small">
												<h3>Learning Objectives</h3>
												<p>This application note has provided step-by-step instructions for running the VxWorks 6.9.3.1 BSP on the Zynq-7000 SoC All Programmable device platform, and additionally provided an overview of the boot process for the Zynq-7000 AP SoC platform.</p>
												<p>You will know the steps for using VxWorks RTOS on the Zynq-7000 AP SoC platform.</p>
											</div>
										</div>
										<!-- Break -->

                                                                <section>
                                                                        <header class="major">
										<h2>Summary</h2>
                                                                        </header>
                                                                </section>

                                                                        <!-- Content -->
									<p>VxWorks from Wind River:</p>
									<ul>
										<li>Is a Real Time Operating system (RTOS).</li>
										<li>Is a platform-based approach with configurable components that relate to different architecture support, network, file system, compiler and development tool chains.</li>
										<li>Supports the Zynq®-7000 All Programmable (AP) SoC architecture of multicore processor systems.</li>
										<li>Has support for asymmetric multiprocessing (AMP) and symmetric multiprocessing (SMP).</li>
									</ul>

									<p>This application note is intended as a getting started guide for new users of VxWorks on the Zynq-7000 device. The document contains the following primary sections:</p>
									<ul>
										<li>Introduction: Explains the important elements of the Zynq-7000 software environment to provide a better understanding of BSP and application generation. This includes the:</li>
										<ul>
											<li>ROM mechanism</li>
											<li>Function of the first stage bootloader (FSBL)</li>
											<li>Wind River bootloader</li>
											<li>Explanation of the Zynq-7000 processor subsystem boot process</li>
										</ul>
										<li>Building VxWorks for Zynq-7000 AP SoC, page 5: Explains native flash (SD Card) and remote Ethernet (FTP) boot source options and the bootloader configurations for both options.</li>
										<li>Building and Debugging the Application, page 17: Explains how to create, build and remotely run a custom application with VxWorks on a Zynq-7000 device.</li>
										<li>Accessing a Peripheral in the Processing System, page 20: Describes how to access peripheral systems in the Zynq-7000 Processing System (PS).</li>
										<li>Conclusion, page 25: Summarizes what this application note describes.</li>
										<li>Additional Resources, page 25: Provides additional resource links.</li>
									</ul>
									<blockquote>
										<p>This document assumes familiarity with the Xilinx® ISE® Design Suite and Zynq-7000 AP SoC design methodology. This document includes a reference system for the Xilinx ZC702 board derived from the Zynq-7000 AP SOC - Concepts, Tools and Techniques User Guide [Ref 1], which provides the details on how to rebuild such a system.</p>
									</blockquote>

                                                                <section>
                                                                        <header class="major">
										<h2>Hardware and Software Requirements</h2>
                                                                        </header>
                                                                </section>
										<!-- Break -->

										<h2 id="content">Software Requirements</h2>
										<ul>
											<li>Xilinx® ISE® Design Suite: Embedded or System Edition 14.6 or Vivado® Design Suite, 2013.2.</li>
											<li>Wind River Workbench for VxWorks 6.9.3, which includes a Zynq-7000 AP SoC BSP</li>
											<li>Serial Communication utility program (such as Tera Term)</li>
										</ul>
										<h2 id="content">Hardware Requirements</h2>
										<ul>
											<li>Xilinx ZC702 Development Board</li>
											<li>Ethernet Cable</li>
											<li>USB UART Cable</li>
										</ul>

                                                                <section>
                                                                        <header class="major">
										<h2 id="content">Introduction</h2>
                                                                        </header>
                                                                </section>

										<p>The Zynq-7000 AP SOC devices takes advantage of the on-chip CPU to facilitate configuration. Initial device configuration of the processing system (PS) and the programmable logic (PL) must take place through the PS when not using JTAG.</p>
										<p>Two major blocks control the configuration:</p>
										<ul>
											<li>The first is the BootROM which is a static block of memory that is executed by the multiprocessor core after power-on reset and warm reset.</li>
											<li>The second major block is the device configuration unit which controls JTAG debug access and provides an interface to the AES, HMAC, and PCAP blocks for PL configuration and data decryption.</li>
										</ul>
										<p>Both the PS and PL can be configured under PS control either securely or non-securely. Configuration under external host control is also possible using JTAG.</p>
										<p>Unlike other Xilinx 7 series devices, Zynq-7000 AP SOC devices do not support initial PL controlled configuration. Configuration on the Zynq-7000 AP SOC devices is a multi-step process. The configuration process involves a minimum of two stages, but generally requires three stages.</p>
										<p>The stages are:</p>
										<ul>
											<li>Stage 0: BootROM, page 3: Referred to as the BootROM, this stage controls initial device startup. The BootROM is non-modifiable code executed by the processor after power-on reset and warm reset.</li>
											<li>Stage 1: First Stage Bootloader, page 4: This is generally a first stage boot loader (FSBL), but it can be any user-controlled code. See the Zynq-7000 AP SOC Software Developers Guide (UG821) [Ref 1] for details about FSBL.</li>
											<li>Stage 2: VxWorks Bootloader, page 4: This is generally user-configurable software that can act as a second stage boot loader (SSBL). This stage is completely within user control. In the case of this document, it is part of the VxWorks bootloader.</li>
										</ul>
										<p>Figure 1 below illustrates a non-secure boot process for typical Linux system. Uboot is an example for higher-level boot loader and can be exchanged by VxWorks bootloader.</p>

										<span class="image">
											<img src="images/soc/VxWorks-Zynq-7000-Figure-1.jpg" alt="Boot Flow" />
											<p align="center"><i>Figure 1:</i> <b>Boot Flow</b></p>
										</span>

										<h2 id="content">Stage 0: BootROM</h2>

										<p>The Zynq-7000 AP SoC processor subsystem configuration starts after power-on reset. The ARM® CPU starts executing code from the on-chip BootROM with JTAG disabled. The BootROM contains code for base drivers for NAND, NOR, Quad-SPI, SD, and PCAP. DDR and other peripheral initializations are not performed from the BootROM and must be done in the Stage 1 image, First Stage Bootload (FSBL) or later.</p>

										<p>For security, the CPU is always the first device out of reset among all master modules within the PS. When the BootROM is running the JTAG is disabled to ensure security.</p>

										<p>The BootROM code is also responsible for loading the FSBL. Zynq-7000 AP SoC architecture supports multi-stage user boot image loading; any further user boot image loading after FSBL is the responsibility of the user. When the BootROM releases control to FSBL, user software assumes full control of entire system. The only way to execute the BootROM again is by
performing a reset.</p>

										<p>The PS boot source is selected using the mode-pin signals (indicated by a weak pull-up or pull-down applied to specific pins), which are sampled after during power-on reset. The sampled value is stored in the <b>BOOT_MODE</b> register.</p>
										<p>The BootROM supports encrypted and unencrypted images referred to as secure boot and non-secure boot, respectively. Additionally, the BootROM supports beginning execution of the stage 1 image from OCM after copying the image or executing direct from linear flash (NOR or QSPI) when using the execute-in-place (XIP) feature.</p>
										<ul>
											<li>In secure boot the CPU, running from secure BootROM code, decrypts and authenticates the incoming user PS image, stores it in the OCM RAM, and then branches into that RAM.</li>
											<li>In non-secure boot the CPU, running from BootROM code, disables all secure boot features including the AES engine within the PL before branching to the user image in the OCM RAM or flash, if XIP is used. The Processor System (PS) boot image is limited to 192 KB unless booting with XIP.</li>
										</ul>
										<p>Any subsequent boot stages for either the PS or the PL are the responsibility of the user and are under user control. The BootROM code is not accessible to the user.</p>

										<ul>
											<li>Following the stage 1 secure boot, you can proceed with either secure or non-secure subsequent boot stages.</li>
											<li>Following a non-secure first stage boot, only non-secure subsequent stage boots are possible.</li>
										</ul>
										<p>For secure boot decryption and authentication, the PS uses the hard-wired AES-256 and SHA-256 modules within the PL. For this reason, the PL must be powered up during any secure boot, even if only the PS is configured. The device encryption key is user-selectable from either the on-chip eFUSE unit or the on-chip block RAM.</p>
										<p>The possible boot sources are: NAND, NOR, SD, Quad-SPI, and JTAG. The first four boot sources are used in master boot methods in which the CPU loads the external boot image from nonvolatile memory into the PS.</p>

										<h2 id="content">Stage 1: First Stage Bootloader</h2>
										<p>The First Stage Bootloader (FSBL) starts after the execution of the BootROM. BootRom loads the FSBL into the OCM, or the FSBL executes in place (XIP) unencrypted from memory mapped flash (NOR or Quad-SPI), contingent upon the BootROM header description.</p>
										<p>The FSBL is responsible for:</p>
										<ul>
											<li>Initialization using the PS configuration data provided by Xilinx Platform Studio (XPS) (see "Zynq-7000 PS Configuration" in the Zynq-7000 AP SOC Software Developers Guide (UG821) [Ref 2].</li>
											<li>Programming the PL using a bitstream</li>
											<li>Loading second stage bootloader or bare-metal application code into DDR memory</li>
											<li>Starting execution of the second stage bootloader or bare-metal application</li>
										</ul>
										<p><b>Note:</b> Before handoff to the second stage bootloader or bare-metal application, the FSBL invalidates the instruction cache and disables the cache and MMU, because Linux (and perhaps other operating systems) assume it is disabled upon start.</p>
										<p>See the FSBL code provided with SDK for details on how the FSBL initializes the CPU and peripherals used by the FSBL, and how it uses a simple C run time library.</p>
										<p>The bitstream for the PL and the second stage bootloader or bare-metal application data, as well as other code and data used by the second stage bootloader, Linux (or other operating system), or bare-metal application are grouped into partitions in the flash image.</p>

										<h2 id="content">Stage 2: VxWorks Bootloader</h2>
										<p>The VxWorks bootloader application loads a VxWorks image onto a target. Like VxWorks, you can configure the VxWorks bootloader with various facilities; such as a command line interface for dynamically setting boot parameters, a network loader, and a file system loader.</p>
										<p>Uniprocessor (UP), symmetric multiprocessor (SMP), and asymmetric multiprocessor (AMP), configurations of VxWorks use the same bootloader.</p>
										<p>In a development environment, a bootloader is useful for loading a VxWorks image from a host system, where you can modify and rebuild VxWorks. You can also use a VxWorks bootloader in production systems when the bootloader and operating system are stored on a disk or other media.</p>
										<p>Self-booting (standalone) VxWorks images do not require a bootloader. These images are commonly used in production systems (stored in nonvolatile devices).</p>
										<p>Usually, the bootloader is programmed in a nonvolatile device (usually flash memory or EEPROM) at an address such that it is the first code run by the processor when the target is powered on or rebooted. The procedure to get the boot loader programmed in a nonvolatile device or written to a disk is dependent on the target, and is described in following section using an SD card image.</p>
										<p>The VxWorks product installation includes default bootloader images for each installed BSP. If they do not meet your needs, you can create a custom bootloader.</p>

                                                                <section>
                                                                        <header class="major">
										<h2>Building VxWorks for Zynq-7000 AP SoC</h2>
                                                                        </header>
                                                                </section>
										<h2 id="content">Host Environment Configuration</h2>

										<p>The following steps are one-time only:</p>
										<ol>
											<li>Install VxWorks Tool chain 6.9.3.1.</li>
											<ul>
												<li>Install Base Tools Package.</li>
												<li>Invoke the <b>Product Maintenance</b> GUI.</li>
												<ul>
												
													<li>Update the installer.</li>
													<li>Configure online <b>Content Update Network</b> settings.</li>
												</ul>
											</ul>
											<li>Apply updates based upon your license file, as shown in Figure 2.</li>
										
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-2.jpg" alt="Select Products Dialog Box" />
												<p align="center"><i>Figure 2:</i> <b>Select Products Dialog Box</b></p>
											</span>

											<p>The Zynq-7000 BSP is a standard part of the 6.9.3.1 install, as shown in Figure 3:</p>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-3.jpg" alt="VxWorks BSP: Xilinx Zynq-7000 EPP" />
												<p align="center"><i>Figure 3:</i> <b>VxWorks BSP: Xilinx Zynq-7000 EPP</b></p>
											</span>
											<li>Because of the asynchronous nature of VxWorks BSPs, verify that you install the latest Xilinx BSP. The link is provided at [Ref 4].</li>
											<li>Install the BSP patches as described in the BSP download link: VxWorks 6.9.3.1 BSP Driver Source Patch for BSP, The link is provided at [Ref 5].</li>
											<li>Complete all details of the build steps to apply the patch into the source tree.</li>
										</ol>

										<h2 id="content">Configure and Build a VxWorks BootROM and Kernel Image</h2>

										<p>The default BSP does not enable support for accessing an SD card. Because you use the SD card to store the VxWorks image, the first step is to modify the BSP configuration.</p>
										<ol>
											<li>In a text editor, open the &lt;Install_Dir&gt;/vxworks-6.9/target/config/xlnx_zynq7k/config.h file, and modify line 197:</li>
											<pre><code class="lang-c">
#undef DRV_STORAGE_SDHC/
											</code></pre>
											-&gt;
											<pre><code class="lang-c">
#define DRV_STORAGE_SDHC
#define INCLUDE_DOSFS
#define INCLUDE_DOSFS_MAIN
#define INCLUDE_DOSFS_CHKDSK
#define INCLUDE_DOSFS_FMT
#define INCLUDE_DOSFS_FAT
#define INCLUDE_DOSFS_SHOW
#define INCLUDE_DOSFS_DIR_VFAT
#define INCLUDE_DOSFS_DIR_FIXED
#define INCLUDE_FS_MONITOR
#define INCLUDE_FS_EVENT_UTIL
#define INCLUDE_ERF
#define INCLUDE_XBD
#define INCLUDE_XBD_BLKDEV
#define INCLUDE_XBD_TRANS
#define INCLUDE_DEVICE_MANAGER
#define INCLUDE_XBD_BLK_DEV
#define INCLUDE_XBD_PART_LIB
#define INCLUDE_DISK_UTIL
											</code></pre>
											<p>This enables the SDHC controller, as well as drivers for the FAT file system.</p>
											<p>To use the VxWorks BSP with the Wind River Workbench to create a VxWorks Kernel Image, do the following:</p>

											<li>Start the Wind River Workbench tool and select a workspace.</li>

											<p>The Wind River SDK opens.</p>

											<li>In the main context menu select <b>File &gt; New &gt; Project</b>.</li>

											<p>The New Project Wizard opens.</p>

											<li>Under <b>VxWorks 6.x</b>, select the <b>VxWorks Image Project</b>, as shown in Figure 4.</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-4.jpg" alt="VxWorks Image Project" />
												<p align="center"><i>Figure 4:</i> <b>VxWorks Image Project</b></p>
											</span>

											<p>The New VxWorks Image Project multipage wizard opens.</p>

											<li>Enter a project name, for example, <b>zynq_vxworks_01</b>, and click <b>Next</b>.</li>

											<li>Select the <b>xlnx_zynq7k</b> BSP used for this project as highlighted in Figure 5.</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-5.jpg" alt="VxWorks Image Project Multipage Wizard" />
												<p align="center"><i>Figure 5:</i> <b>VxWorks Image Project Multipage Wizard</b></p>
											</span>

											<li>From the New VxWorks Image Project wizard, select <b>PROFILE_DEVELOPMENT</b> (Figure 6).</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-6.jpg" alt="New VxWorks Image Project: PROFILE_DEVELOPMENT Option" />
												<p align="center"><i>Figure 6:</i> <b>New VxWorks Image Project: PROFILE_DEVELOPMENT Option</b></p>
											</span>

											<li>Click <b>Finish</b>.</li>

											<li>Open the Kernel configuration. Change the configuration to include the symbol table in the Kernel image (Figure 7, page 10).</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-7.jpg" alt="Component Configuration" />
												<p align="center"><i>Figure 7:</i> <b>Component Configuration</b></p>
											</span>

											<p>You can now build the Kernel image.</p>
										</ol>

										<h2 id="content">Building the Kernel Image</h2>

										<ol>
											<li>In the Project Explorer window, mouse over to the Image project, right-click and select <b>Build Project</b>. The VxWorks image file is located in the ,./&lt;project_name&gt;/default directory. Figure 8 shows the Build Project option.</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-8.jpg" alt="Build Project Option" />
												<p align="center"><i>Figure 8:</i> <b>Build Project Option</b></p>
											</span>
											<li>When the project build is complete, start a Wind River VxWorks development shell.</li>
											<p>Use this shell to build a bootROM binary. The bootROM binary is the VxWorks bootloader (similar to Uboot); it is not within the Zynq-7000 device ROM.</p>
											<li>Within the shell, type:</li>
											<pre><code class="lang-bash">
cd ..\&lt;install_dir&gt;\WindRiver\vxworks-6.9\target\config\xlnx_zynq7k\
make clean make bootROM
											</code></pre>
											<p>The commands generate a file with the name bootROM. Rename the file to bootROM.elf</p>
											<li>Create a boot.bif and a zynq_fsbl_0.elf file, with the following format:</li>
											<pre><code class="lang-bash">
ZC702_bif_for_VxWorks:
{
[bootloader]zynq_fsbl_0.elf
bootROM.elf
}
											</code></pre>
											<li>Copy the bootROM.elf, zynq_fsbl_0.elf, and the boot.bif file to the /bootgen directory.</li>
											<p>Alternatively, you can copy the bootgen.exe tool to the current installation directory.</p>
											<p><b>C:\&lt;install_dir&gt;\WindRiver\vxworks-6.9\target\config\xlnx_zynq7k\</b></p>
											<li>In the Wind River shell, type:</li>
											<pre><code class="lang-bash">
bootgen image boot.bif I BOOT.BIN
											</code></pre>
											<li>Copy the following files onto an SD card:</li>
											<ul>
												<li><b>VxWorks</b> from the ..\&lt;project_name&gt;\default directory</li>
												<li><b>BOOT.BIN</b> from the ..\&lt;install_dir&gt;\WindRiver\vxworks 6.9\xlnx_zynq7k\ directory.</li>
											</ul>
											<p>This creates a system that can boot from an SD card.</p>
											<p>The following subsection describes the required steps to boot from an SD card.</p>

										</ol>

										<h2 id="content">Booting From an Secure Digital Card</h2>

										<p>Use the Secure Digital (SD) card to boot the Zynq-7000 AP SoC Processor System (PS).</p>
										<ol>
											<li>Connect a power cable, a Xilinx USB download cable, an Ethernet cable, and a USB UART cable to the board.</li>
											<li>Put the SD Card in the SD card pole of the board. Ensure that the switches for booting from SD Card are in the right position. Ensure that the settings of Jumpers J27 and J28 are the same as shown. Move the DIP-Switches 3 and 4 of SW 16 to the left (this sets the switches to 1) (Figure 9).</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-9.jpg" alt="Image of SD Card and USB Connection" />
												<p align="center"><i>Figure 9:</i> <b>Image of SD Card and USB Connection</b></p>
											</span>

											<p>These settings ensure an SD card boot.</p>
											<li>Open a terminal session, and choose the right COM port () function, and set the <strong>Baud Rate</strong> to <b>115200</b>.</li>
											<li>Switch on the board.</li>
											<li>Stop the Autoboot process by pressing the keyboard <b>Return</b> key.</li>
											<p>The VxWorks bootROM prompt opens.</p>
											<li>Type C at the boot prompt, and press <b>Return</b> to start the boot configuration.</li>
											<li>Change the boot device to fs and press <b>Return</b> until you reach the file name.</li>
											<li>Change to /sd0:1/vxWorks and press <b>Return</b> until you reach other (o).</li>
											<li>If no entry exists, type gem0. Press <b>Return</b> and the boot prompt opens.</li>
											<li>Type <code>@</code> to proceed the boot process.</li>
											<li>Type <code>i</code> to display all running tasks.</li>
											<p>VxWorks boots and presents the output as shown in Figure 10.</p>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-10.jpg" alt="SD Boot Terminal Transcript" />
												<p align="center"><i>Figure 10:</i> <b>SD Boot Terminal Transcript</b></p>
											</span>

										</ol>

										<h2 id="content">Booting Using FTP</h2>

										<p>Repeat the first four steps shown in <b>Booting From an Secure Digital Card</b>, as follows:</p>
										<ol>
											<li>Connect a power cable, a Xilinx USB download cable, an Ethernet cable, and a USB UART cable to the board.</li>
											<li>Put the SD Card in the SD card pole of the board. Ensure that the switches for booting from SD Card are in the right position. Open a terminal session, and choose the right COM port () function, and set the <b>Baud Rate</b> to <b>115200</b>.</li>
											<li>Change the local area network (LAN) connection of your system network settings to the IP address <b>192.168.1.1</b>.</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-11.jpg" alt="Host Ethernet MAC Configuration" />
												<p align="center"><i>Figure 11:</i> <b>Host Ethernet MAC Configuration</b></p>
											</span>
											<li>Start an FTP server. You can use the server delivered with the Wind River tool chain.</li>
											<p>If you use the Wind River FTP server, select <b>Security &gt; User/rights</b>.</p>
											<li>Click <b>New User</b> and type a name; for example, <b>Zynq</b> and a password.</li>
											<li>Type the home directory of the VxWorks image, then click <b>Done</b>.</li>
											<li>Switch on the board.</li>
											<li>Stop the Autoboot process by pressing <b>Return</b>.</li>
											<p>The VxWorks bootROM prompt opens.</p>
											<li>At the boot prompt, type <code>c</code> then press <b>Return</b> to start the boot configuration.</li>
											<li>Type <b>gem0</b> to change boot device then press <b>Return</b> until you reach <b>File Name</b>.</li>
											<li>Type <b>VxWorks</b>, then press <b>Return</b> until you reach <b>inet on ethernet (e)</b>.</li>
											<li>Change the <b>inet on ethernet (e)</b> to IP address <b>192.168.1.2:0xffffff00</b>, then press <b>Return</b> until you reach <b>host inet (h)</b>.</li>
											<li>Change <b>host inet (h)</b> IP address <b>192.169.1.1</b>, then press <b>Return</b> until you reach <b>user</b>.</li>
											<li>Type the user name you choose for the server then press <b>Return</b> until you reach <b>password (pw)</b>.</li>
											<li>Type password you choose for the server, then press <b>Return</b> until you reach <b>other (o)</b>.</li>
											<li>If no entry exists, type <b>gem0</b>, then press <b>Return</b>.</li>
											<p>The boot prompt opens.</p>
											<li>Type <code>@</code> to start the boot process.</li>
											<p>VxWorks boots from the image using the terminal (Figure 12).</p>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-12.jpg" alt="Boot Terminal Transcript" />
												<p align="center"><i>Figure 12:</i> <b>Boot Terminal Transcript</b></p>
											</span>
										</ol>

                                                                <section>
                                                                        <header class="major">
										<h2>Building and Debugging the Application</h2>
                                                                        </header>
                                                                </section>

										<h2 id="content">Creating the Hello World Application</h2>
										<p>As short example, the following instructions describe how to build and download a small "Hello World" application to the remote target after you have set up and are running VxWorks.</p>
										<p>The assumptions are:</p>
										<ul>
											<li>You have followed the prior stages of this document.</li>
											<li>VxWorks is executing on the target (with remote debug enabled).</li>
											<li>An Ethernet connection is present between the host and the target.</li>
										</ul>

										<p>To create the "Hello World" application:</p>

										<ol>
											<li>Select File &gt; New &gt; Project &gt; VxWorks Downloadable Kernel Module Project, as shown in Figure 13.</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-13.jpg" alt="New Project Wizard" />
												<p align="center"><i>Figure 13:</i> <b>New Project Wizard</b></p>
											</span>

											<li>Click <b>Next</b> and enter a project name; for example, <b>hello_world</b>, (Figure 14), then press <b>Finish</b>.</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-14.jpg" alt="New Kernel Module Project" />
												<p align="center"><i>Figure 14:</i> <b>New Kernel Module Project</b></p>
											</span>
											<p>A <b>hello_world</b> project opens in the Project Explorer Window.</p>
											<li>Move the mouse to the Project. Click the right button and select <b>New &gt; File</b>.</li>
											<li>Enter a file name; for example, hello.c, and click <b>Finish</b>.</li>
											<li>Enter the following code into the file:</li>
											<pre><code class="lang-c">
#include &lt;stdio.h&gt;
void hello()
{
	printf("Hello Wind River\n");
}
											</code></pre>
											<li>In the Project Explorer window, select <b>Build Targets</b> (Figure 15), and click the right mouse button.</li>

											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-15.jpg" alt="Build Target Selection" />
												<p align="center"><i>Figure 15:</i> <b>Build Target Selection</b></p>
											</span>

											<li>Select <b>Build Options &gt; Set Active Build Spec &gt; ARMARCH7</b>&lt;gnu|diab&gt;.</li>
											<p>A message opens that asks if you want to set the active build spec to <b>ARMARCH7</b>&lt;gnu|diab&gt; (Figure 16).</p>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-16.jpg" alt="Build Target Configuration" />
												<p align="center"><i>Figure 16:</i> <b>Build Target Configuration</b></p>
											</span>

											<li>Select <b>YES</b>.</li>
											<li>Build the project. A message opens.</li>
											<li>Click <b>Continue</b>.</li>
											<li>In the bottom-left corner of the Wind River Workbench, go to <b>Remote Systems</b>.</li>
											<li>In the window, right-click and select <b>New &gt; Connection</b>.</li>
											<li>Select <b>Wind River VxWorks 6.x Target Server Connection</b>, and click <b>Next</b>.</li>
											<li>Type the target IP address of <b>192.168.1.2</b>, and the path to the kernel image (in this case type: <code>..\&lt;project_name&gt;\default</code>). Click <b>Finish</b>.</li>
											<li>Right-click the new connection, and click <b>Connect</b>.</li>
											<li>In the Project Explorer window, right-click <b>Build Targets</b>, then select <b>Debug VxWorks Kernel Task</b>.</li>
											<li>The Debug Configuration window opens, as shown in Figure 17</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-17.jpg" alt="Debug Configuration Window" />
												<p align="center"><i>Figure 17:</i> <b>Debug Configuration Window</b></p>
											</span>
											<li>From <b>General</b> &gt; <b>Entry</b>, type <b>hello</b> to locate the <b>hello world</b> project.</li>
											<p>Alternatively, you can use the <b>Browse</b> button to find the <b>hello world</b> project.</p>
											<li>Click <b>Debug</b>.</li>
											<p>The terminal window that is connected to the board issue the following message:</p>
											<pre><code class="lang-mark">
>> Break at 0x0144accc: hello +0x4 Task: 0x14cdfc0 (Hello)
											</code></pre>
											<blockquote>
												Note: The message can differ slightly from yours as it depends on your Kernel settings. It just gives
											</blockquote>
											<p>you the hint that a task was downloaded and stopped for debug.</p>
											<li>In the debug window, click the <b>Run</b> button.</li>
											<p>The terminal window displays: Hello Wind River.</p>
											<li>Type <code>i</code> to see the tasks in the VxWorks task list.</li>
											<li>Type <code>repeat 10,hello</code> to repeat the task 10 times.</li>

										</ol>

                                                                <section>
                                                                        <header class="major">
										<h2>Accessing a Peripheral in the Processing System</h2>
                                                                        </header>
                                                                </section>

										<p>In the ARM® Cortex™ A9 processor, every peripheral is memory mapped. The address map for the Zynq-7000 AP SoC processor, for example, is listed in the Zynq-7000 AP SoC Technical Reference Manual (UG585) [Ref 2].</p>

										<h2 id="content">Modifying the Hello World Application</h2>
										<p>Modify the "Hello World" application to access the GPIO peripheral. On the ZC702 board, MIO pin 10 is connected to an LED (DS12).</p>
										<p>From the Zynq-7000 AP SoC Technical Reference Manual, (UG585) [Ref 6], you see that the base address of the GPIO peripheral is 0XE000A000. To access pin 10 as an output, you must configure this peripheral first:</p>
										<ol>
											<li>Set the direction to output by writing a 1 to bit 10 of the gpio.DIRM_0 register.</li>
											<li>Enable the output by writing a 1 to bit 10 of the gpio.OEN_0 register.</li>
											<li>Write to bit 10 of the gpio.DATA_0 register to control the LED.</li>
											<p>The updated source code of the hello world application now looks like the following:</p>
											<pre><code class="lang-c">
#include &lt;stdio.h&gt;
#include &lt;sys/mman.h&gt;
#define GPIO_BASE 0xE000A000
#define GPIO_DIRM_0 0x00000204
#define GPIO_OEN_0 0x00000208
#define GPIO_DATA_0 0x00000040
int main(void)
{
	printf("Hello World!\n");
	int val = 0xffffffff;
	sysOutLong(GPIO_BASE + GPIO_DIRM_0, 0x00000400);
	sysOutLong(GPIO_BASE + GPIO_OEN_0, 0x00000400);
	while (1) {
		sysOutLong(GPIO_BASE + GPIO_DATA_0, val);
		sleep(1);
		val ^= 0xffffffff;
	}
	return 0;
}
											</code></pre>
											<li>Save this file, then build and debug this application following steps 9 to 19 of the previous section. The result is that the LED toggles every second.</li>
										</ol>

                                                                <section>
                                                                        <header class="major">
										<h2>Accessing a Peripheral in the Programmable Logic</h2>
                                                                        </header>
                                                                </section>

										<p>Accessing a peripheral in the Programmable Logic is very similar to accessing a peripheral in the processing system: both master GP AXI interfaces have an address space of 1GB, as can be seen in the Address Map table in the Zynq-7000 AP SoC Technical Reference Manual (UG585) [Ref 6]. The differences are:</p>
										<ul>
											<li>You must first program the PL with a BIT file containing the AXI_GPIO peripheral.</li>
											<li>You must modify the VxWorks BSP to allow access to the address range that you configured for that peripheral.</li>
										</ul>
										<p>The design created for this section contains an AXI_GPIO peripheral connected to the M_AXI_GP0 port of the PS.</p>
										<p>The four GPIO pins of the AXI_GPIO peripheral are connected to the DS15 to DS18 LEDs on the ZC702 board.</p>
											
										<span class="image">
											<img src="images/soc/VxWorks-Zynq-7000-Figure-18.jpg" alt="Zynq-7000 Processor System and Peripherals" />
											<p align="center"><i>Figure 18:</i> <b>Zynq-7000 Processor System and Peripherals</b></p>
										</span>

										<p>The Address Editor shows the base address where this peripheral is mapped, as shown in Figure 19.</p>

										<span class="image">
											<img src="images/soc/VxWorks-Zynq-7000-Figure-19.jpg" alt="Address Editor" />
											<p align="center"><i>Figure 19:</i> <b>Address Editor</b></p>
										</span>
										<p>After implementing this design, you generate a new FSBL, and use this FSBL, together with the generated BIT file, to create a new boot.bin file to download to the SD card.</p>
										<ol>
											<li>Follow the same steps as you used but use a slightly modified boot.bif file, as follows:</li>
											<pre><code class="lang-c">
//ZC702_bif_for_VxWorks:
{
[bootloader]fsbl.elf
bitfile.bit
bootROM.elf
}
											</code></pre>
											<p>Where:</p>
											<ul>
												<li>-fsbl.elf is the new FSBL.</li>
												<li>-bitfile.bit is the BIT created by the hardware design.</li>
											</ul>
											<p>This produces a new boot.bin file to boot the ZC702 board.</p>
											<li>To access the peripheral from within a VxWorks kernel module, first modify the BSP.</li>
											<p>The default configuration of the VxWorks BSP configures the MMU to allow access to a limited set of addresses, listed in the documentation of the BSP.</p>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-20.jpg" alt="Memory Map" />
												<p align="center"><i>Figure 20:</i> <b>Memory Map</b></p>
											</span>

										</ol>

										<h2 id="content">Adding the Address Range to the MMU Configuration</h2>
										<p>The M_AXI_GP ports are not mapped.</p>
										<p>To add the address range to the MMU configuration, modify the VxWorks BSP:</p>
										<ol>
											<li>Open the VxWorks image project, then browse to the /xlns_zynq7k folder.</li>
											<li>Double-click the sysLib.c file to open the file in the Text Editor.</li>
											<span class="image">
												<img src="images/soc/VxWorks-Zynq-7000-Figure-21.jpg" alt="MMU Configuration" />
												<p align="center"><i>Figure 21:</i> <b>MMU Configuration</b></p>
											</span>
										
											<li>In the syslib.c file, scroll down to line 109, find the struct containing the MMU configuration.</li>
											<p>For example, on line 225, find the mapping for the GPIO peripheral used in the previous example:</p>
										
											<pre><code class="lang-c">
{
ZYNQ7K_GPIO_BASE,/* Zynq-7000 gpio */ ZYNQ7K_GPIO_BASE,
PAGE_SIZE,
MMU_ATTR_VALID_MSK | MMU_ATTR_PROT_MSK |
MMU_ATTR_DEVICE_SHARED_MSK,
MMU_ATTR_VALID |MMU_ATTR_SUP_RWX|
MMU_ATTR_DEVICE_SHARED
},
											</code></pre>
										
											<li>Add the mapping for the AXI_GPIO peripheral by adding the following line:</li>
											<pre><code class="lang-c">
{
0x41200000,/* My AXI gpio */
0x41200000, PAGE_SIZE,
MMU_ATTR_VALID_MSK | MMU_ATTR_PROT_MSK |
MMU_ATTR_DEVICE_SHARED_MSK,
MMU_ATTR_VALID| MMU_ATTR_SUP_RWX|
MMU_ATTR_DEVICE_SHARED
},
										
											</code></pre>
										
											<li>Save the file, and rebuild the VxWorks project.</li>
										
											<li>Use this VxWorks image, and either:</li>
										
											<ul>
											
												<li>-Put the image on the SD card to boot from SD, or</li>
											
												<li>-When fetching the VxWorks image over FTP, boot the board with the updated boot.bin file.</li>
										
											</ul>
										
											<li>After booting the ZC702 board with this SD card, the FSBL configures the PL before launching the VxWorks BootROM.</li>
										
											<p>The BootROM then loads the updated VxWorks image.</p>
										</ol>

										<h2 id="content">Updating the Hello World Project</h2>
										<p>Update the "hello world" project to access the AXI peripheral. The AXI_GPIO peripheral is slightly different from the hardened GPIO peripheral: you need only to set the direction, not enable the output driver.</p>
										<p>Change the contents of the file to:</p>

										<pre><code class="lang-c">
#include &lt;stdio.h&gt;
#include &lt;sys/mman.h&gt;
#define AXI_GPIO_BASE 0x41200000
#define AXI_GPIO_TRI 0x04
#define AXI_GPIO_DATA 0x00
int main(void)
{
    printf("Hello World!\n");
    int val = 0;
    sysOutLong(AXI_GPIO_BASE + AXI_GPIO_TRI, 0);
    while (1) {
        sysOutLong(AXI_GPIO_BASE + AXI_GPIO_DATA, val);
        printf("%d\n", val);
        sleep(1);
        val++;
        if (val == 0x10000)
	{
		val = 0;
	}
    return 0;
}
										</code></pre>
										<p>When you rebuild this project, and run it on the ZC702 board, it toggles the LEDs every second.</p>


                                                                <section>
                                                                        <header class="major">
										<h2>Conclusion</h2>
                                                                        </header>
                                                                </section>
										<p>This application note has provided step-by-step instructions for running the VxWorks 6.9.3.1 BSP on the Zynq-7000 SoC All Programmable device platform, and additionally provided an overview of the boot process for the Zynq-7000 AP SoC platform.</p>
								
										<p>You now know the steps for using VxWorks RTOS on the Zynq-7000 AP SoC platform.</p>

                                                                <section>
                                                                        <header class="major">
										<h2>Additional Resources</h2>
                                                                        </header>
                                                                </section>
										<p>The following links are to additional resources referenced in this document:</p>
										<ol>
											<li>Zynq-7000 AP SOC - Concepts, Tools and Techniques User Guide (UG837)</li>
											<li>Zynq-7000 All Programmable SoC Software Developers Guide (UG821)</li>
											<li>Zynq-7000 AP SoC Technical Reference Manual, (UG585)</li>
											<li>Xilinx BSP: gppve_6_9_xlnx_zynq7k_6_9_2:</li>
											<p>https://portal.windriver.com/cgi-bin/windsurf/bsp/infoBSP.cgi?id=12020</p>
											<li>VxWorks 6.9.3.1 BSP Driver Source Patch:</li>
											<p>https://support.windriver.com/olsPortal/faces/maintenance/downloadDetails.jspx?contentId=041654</p>
											<li>VxWorks 6.9.3.1 USB L2 Cache Source Patch:</li>
											<p>https://support.windriver.com/olsPortal/faces/maintenance/downloadDetails.jspx?contentId=041575</p>
										</ol>

                                                                		<!-- Break -->

										<hr class="major" />

										<div class="row">
                                                                                        <div class="col-4 col-12-medium">
                                                                                        </div>
                                                                                        <div class="col-4 col-12-medium">
												<ul class="actions">
													<li><a href="vxworks-on-xen-on-arm-cortex-a53.html" class="button primary fit">Related</a></li>
												</ul>
                                                                                        </div>
                                                                                        <div class="col-4 col-12-medium">
                                                                                        </div>
                                                                                </div>



						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
						<div class="inner">

							<!-- Search -->
								<section id="search" class="alt">
									<form method="get" action="https://www.google.com/search" target="_blank">
										<input type="hidden" name="sitesearch" value="www.vxworks6.com" />
										<input type="text" name="query" id="query" placeholder="Search" />
									</form>
								</section>

							<!-- Menu -->
								<nav id="menu">
									<header class="major">
										<h2>Menu</h2>
									</header>
									<ul>
										<li><a href="index.html">Homepage</a></li>
										<li>
											<span class="opener">Getting started with VxWorks</span>
											<ul>
												<li><a href="the-wind-river-ecosystem.html">The Wind River Ecosystem</a></li>
												<li><a href="vxworks-key-features.html">VxWorks Key Features</a></li>
												<li><a href="workbench-4-overview.html">Workbench 4 Overview</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Target and connections overview</span>
											<ul>
												<li><a href="hardware-target-configuration.html">Hardware Target Configuration</a></li>
												<li><a href="booting-a-hardware-target.html">Booting a Hardware Target</a></li>
												<li><a href="workbench-tools-architecture.html">Workbench Tools Architecture</a></li>
												<li><a href="simulation-overview.html">Simulation Overview</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">Managing Projects in Workbench</span>
											<ul>
												<li><a href="introduction-to-projects-and-workspaces.html">Introduction to Projects and Workspaces</a></li>
												<li><a href="vxworks-directory-structure-and-package-management.html">VxWorks Directory Structure and Package Management</a></li>
												<li><a href="vxworks-source-build-and-image-projects.html">VxWorks Source Build and Image Projects</a></li>
												<li><a href="the-vxprj-utility.html">The vxprj Utility</a></li>
												<li><a href="read-only-memory-file-system.html">Read-Only Memory File System</a></li>
												<li><a href="configuring-and-building-a-project.html">Configuring and Building a Project</a></li>
											</ul>
										</li>
										<li>
											<span class="opener">VxWorks Kernel Shell</span>
											<ul>
												<li><a href="introduction-to-the-kernel-shell.html">Introduction to the Kernel Shell</a></li>
												<li><a href="command-line-editing-and-object-module-loader.html">Command-line Editing and Object-Module Loader</a></li>
												<li><a href="kernel-shell-configuration-and-commands.html">Kernel Shell Configuration and Commands</a></li>
												<li><a href="kernel-shell-usage.html">Kernel Shell Usage</a></li>
												<li><a href="wrap-up.html">Let's Wrap Up</a></li>
											</ul>
										</li>
									</ul>
								</nav>

							<!-- Section -->
								<section>
									<header class="major">
										<h2>Popular</h2>
									</header>
									<div class="mini-posts">
										<article>
											<a href="configuring-and-building-a-project.html" class="image"><img src="images/Configuring-and-Building-a-Project-small.png" alt="Configuring and Building a Project" /></a>
											<p>Configuring and setting up the VSB and VIP is known as platform development.</p>
										</article>
										<article>
											<a href="vxworks-key-features.html" class="image"><img src="images/VxWorks-key-features-small.png" alt="VxWorks Key Features" /></a>
											<p>VxWorks is a robust operating system; it has many useful and powerful features for you to use in your project.</p>
										</article>
										<article>
											<a href="hardware-target-configuration.html" class="image"><img src="images/Hardware-Target-Configuration-small.png" alt="Hardware Target Configuration" /></a>
											<p>All VxWorks projects are different, but they all require hardware configuration.</p>
										</article>
										<article>
											<a href="using-vxWorks-bsp-with-zynq-7000-ap-soc.html" class="image"><img src="images/soc/VxWorks-on-Zynq-UltraScale-MPSoC-small.png" alt="VxWorks BSP with Zynq 7000" /></a>
											<p>Step-by-step instructions for running the VxWorks 6.9.3.1 BSP on the Zynq-7000 SoC.</p>
										</article>
									</div>
									<ul class="actions">
										<li><a href="using-vxWorks-bsp-with-zynq-7000-ap-soc.html" class="button">More</a></li>
									</ul>
								</section>

							<!-- Section -->
								<section>
									<header class="major">
										<h2>Get in touch</h2>
									</header>
									<ul class="contact">
										<li class="icon solid fa-envelope"><a href="#">admin@vxworks6.com</a></li>
									</ul>
								</section>

							<!-- Footer -->
								<footer id="footer">
                                                                        <p class="copyright">VxWorks Club &copy; <a href="https://www.vxworks.net" target="_blank">VxWorks</a></p>
								</footer>

						</div>
					</div>

			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>
